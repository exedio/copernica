<?xml version="1.0"?>

<project name="cope" default="all" basedir=".">

	<target name="properties">
		<property file="../local.properties" />
		<property name="api.private" value="off" />
		<property name="api.link.jdk" value="http://intranet.exedio.com/jdk-1.4.1-doc/api" />
		<!--<property name="api.link.jdk" value="http://java.sun.com/j2se/1.4.2/docs/api" />-->
	</target>

	<target name="lib.compile.mkdir">
		<mkdir dir="lib/build/classes" />
	</target>

	<target name="lib.compile" depends="lib.compile.mkdir">
		<javac srcdir="lib/src"
				destdir="lib/build/classes"
				deprecation="on"
				debug="on"
				optimize="off">
			<classpath>
				<pathelement location="../lib/pcj.jar" />
			</classpath>
		</javac>
	</target>

	<target name="lib.oracle.compile" depends="lib.compile.mkdir, lib.compile">
		<javac srcdir= "lib/oraclesrc"
				destdir="lib/build/classes"
				deprecation="on"
				debug="on"
				optimize="off">
			<classpath>
				<pathelement location="../lib/classes12.zip" />
			</classpath>
		</javac>
	</target>

	<target name="instrument.compile" depends="lib.compile">
		<mkdir dir="instrument/build/classes" />
		<javac srcdir="instrument/src"
				destdir="instrument/build/classes"
				deprecation="on"
				debug="on"
				optimize="off">
			<classpath>
				<pathelement location="lib/build/classes" />
			</classpath>
		</javac>
	</target>
	
	<target name="copernica.compile.classes" depends="lib.compile">
		<mkdir dir="copernica/build/classes" />
		<javac srcdir= "copernica/src"
				destdir="copernica/build/classes"
				deprecation="on"
				debug="on"
				optimize="off">
			<classpath>
				<pathelement location="lib/build/classes" />
			</classpath>
		</javac>
	</target>
	
	<target name="compile" depends="lib.compile, lib.oracle.compile, instrument.compile, copernica.compile, copernica.test.compile" />
	
	<target name="lib.jar" depends="lib.compile, lib.oracle.compile">
		<jar jarfile="lib/build/cope.jar" basedir="lib/build/classes" />
	</target>
	
	<target name="instrument.jar" depends="instrument.compile">
		<jar jarfile="instrument/build/cope-instrument.jar" basedir="instrument/build/classes" />
	</target>
	
	<target name="copernica.jar" depends="copernica.compile">
		<jar jarfile="copernica/build/copernica.jar" basedir="copernica/build/classes" />
	</target>
	
	<target name="jar" depends="lib.jar, instrument.jar, copernica.jar" />
	
	<target name="lib.test.instrument" depends="lib.compile, lib.oracle.compile, instrument.compile">
		<echo message="Instrumenting lib/testsrc" />
		<java classname="com.exedio.cope.instrument.Main" failonerror="yes">
			<classpath>
				<pathelement location="../lib/pcj.jar" />
				<pathelement location="lib/build/classes" />
				<pathelement location="instrument/build/classes" />
			</classpath>
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/ItemWithSingleUnique.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/ItemWithSingleUniqueReadOnly.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/ItemWithSingleUniqueNotNull.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/ItemWithDoubleUnique.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/EmptyItem.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/EmptyItem2.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/AttributeEmptyItem.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/AttributeItem.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/StringItem.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/MediaItem.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/SumItem.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/PointerItem.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/PointerItem2.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/QualifiedEmptyQualifier.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/QualifiedItem.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/hierarchy/Super.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/hierarchy/FirstSub.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/hierarchy/SecondSub.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/collision/CollisionItem1.java" />
			<arg value="${basedir}/lib/testsrc/com/exedio/cope/lib/collision/CollisionItem2.java" />
		</java>
	</target>
	
	<target name="lib.test.compile" depends="lib.test.instrument">
		<mkdir dir="lib/build/testclasses" />
		<javac srcdir="lib/testsrc"
				destdir="lib/build/testclasses"
				deprecation="on"
				debug="on"
				optimize="off">
			<classpath>
				<pathelement location="lib/build/classes" />
				<pathelement location="../lib/junit.jar" />
			</classpath>
		</javac>
	</target>
	
	<target name="lib.test.run.hsql" depends="lib.test.compile">
		<mkdir dir="lib/build/media" />
		<java classname="junit.textui.TestRunner" taskname="junit" fork="yes" failonerror="yes">
			<classpath>
				<pathelement location="lib/build/classes" />
				<pathelement location="lib/build/testclasses" />
				<pathelement location="../lib/junit.jar" />
				<pathelement location="../lib/pcj.jar" />
				<pathelement location="../lib/hsqldb.jar" />
			</classpath>
			<arg value="com.exedio.cope.lib.PackageTest" />
			<sysproperty key="com.exedio.cope.properties" file="cope.properties.hsqldb" />
		</java>
	</target>

	<target name="lib.test.run.oracle" depends="lib.test.compile">
		<mkdir dir="lib/build/media" />
		<java classname="junit.textui.TestRunner" taskname="junit" fork="yes" failonerror="yes">
			<classpath>
				<pathelement location="lib/build/classes" />
				<pathelement location="lib/build/testclasses" />
				<pathelement location="../lib/junit.jar" />
				<pathelement location="../lib/pcj.jar" />
				<pathelement location="../lib/classes12.zip" />
			</classpath>
			<arg value="com.exedio.cope.lib.PackageTest" />
			<sysproperty key="com.exedio.cope.properties" file="cope.properties.oracle" />
		</java>
	</target>

	<target name="lib.test.run" depends="lib.test.run.hsql, lib.test.run.oracle" />

	<target name="lib.test.teardown.database" depends="lib.compile, lib.oracle.compile, lib.test.compile">
		<java classname="com.exedio.cope.lib.DatabaseLibTest" taskname="tear down tables" fork="yes" failonerror="yes">
			<classpath>
				<pathelement location="lib/build/classes" />
				<pathelement location="lib/build/testclasses" />
				<pathelement location="../lib/pcj.jar" />
				<pathelement location="../lib/junit.jar" />
				<pathelement location="../lib/hsqldb.jar" />
				<pathelement location="../lib/classes12.zip" />
			</classpath>
			<sysproperty key="com.exedio.cope.properties" file="cope.properties.oracle" />
		</java>
	</target>

	<target name="teardown" depends="lib.test.teardown.database" />


	<target name="lib.test" depends="lib.test.run" />

	<target name="instrument.test.compile" depends="instrument.compile">
		<mkdir dir="instrument/build/testclasses" />
		<javac srcdir="instrument/testsrc"
				destdir="instrument/build/testclasses"
				deprecation="on"
				debug="on"
				optimize="off">
			<classpath>
				<pathelement location="instrument/build/classes" />
				<pathelement location="../lib/junit.jar" />
			</classpath>
		</javac>
		<copy
			file="instrument/testsrc/com/exedio/cope/instrument/Example.java"
			todir="instrument/build/testclasses/com/exedio/cope/instrument" />
	</target>
	
	<target name="instrument.test.run" depends="instrument.test.compile">
		<java classname="junit.textui.TestRunner" taskname="junit" fork="yes" failonerror="yes">
			<classpath>
				<pathelement location="instrument/build/classes" />
				<pathelement location="instrument/build/testclasses" />
				<pathelement location="../lib/junit.jar" />
			</classpath>
			<arg value="com.exedio.cope.instrument.PackageTest" />
		</java>
	</target>
	
	<target name="instrument.test" depends="instrument.test.run" />
	
	<target name="test" depends="lib.test, instrument.test" />
	
	
	<target name="copernica.jspc">
		<delete dir="copernica/build/jspsrc" />
		<mkdir dir="copernica/build/jspsrc" />
		<java classname="org.apache.jasper.JspC" taskname="jasper2" failonerror="yes" fork="yes">
			<classpath>
				<fileset dir="${basedir}/../tomcat/bin">
					<include name="*.jar" />
				</fileset>
				<fileset dir="${basedir}/../tomcat/common/lib">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<arg value="-p" /><arg value="com.exedio.copernica" />
			<arg value="-uriroot" /><arg value="${basedir}/copernica/jsp" />
			<arg value="-webinc" />
			<arg value="${basedir}/copernica/build/copernica.web.xml.fragment" />
			<arg value="-d" /><arg value="${basedir}/copernica/build/jspsrc" />
		</java>
	</target>
	
	<target name="copernica.compile.jsp" depends="copernica.jspc, copernica.compile.classes">
		<javac destdir="copernica/build/classes"
			optimize="off"
			debug="on"
			failonerror="true"
			srcdir="copernica/build/jspsrc"
			excludes="**/*.smap">
			<classpath>
				<pathelement location="lib/build/classes" />
				<pathelement location="${basedir}/../tomcat/common/classes"/>
				<fileset dir="${basedir}/../tomcat/common/lib">
					<include name="*.jar"/>
				</fileset>
				<pathelement location="${basedir}/../tomcat/shared/classes"/>
			</classpath>
			<include name="**" />
			<exclude name="tags/**" />
		</javac>
	</target>
	
	<target name="copernica.compile" depends="copernica.compile.classes, copernica.compile.jsp" />
	
	<target name="copernica.test.compile" depends="lib.compile, lib.test.compile, copernica.compile">
		<mkdir dir="copernica/build/testclasses" />
		<javac srcdir="copernica/testsrc"
				destdir="copernica/build/testclasses"
				deprecation="on"
				debug="on"
				optimize="off">
			<classpath>
				<pathelement location="lib/build/classes" />
				<pathelement location="lib/build/testclasses" />
				<pathelement location="copernica/build/classes" />
				<pathelement location="../lib/junit.jar" />
			</classpath>
		</javac>
	</target>
	
	<target name="copernica.testwebapp.hsqldb"
			depends="copernica.compile, copernica.test.compile">
		
		<mkdir dir="copernica/build/testwebapp-hsqldb" />
		
		<copy todir="copernica/build/testwebapp-hsqldb/WEB-INF/classes">
			<fileset dir="lib/build/classes" />
			<fileset dir="lib/build/testclasses" />
			<fileset dir="copernica/build/classes" />
			<fileset dir="copernica/build/testclasses" />
		</copy>
		
		<copy todir="copernica/build/testwebapp-hsqldb/WEB-INF/lib">
			<fileset file="../lib/pcj.jar" />
			<fileset file="../lib/hsqldb.jar" />
			<!-- TODO: removed, when the test model gets it own model class independent of junit -->
			<fileset file="../lib/junit.jar" />
		</copy>
		
		<copy tofile="copernica/build/testwebapp-hsqldb/WEB-INF/cope.properties"
				file="cope.properties.hsqldb" />
		<copy todir="copernica/build/testwebapp-hsqldb/WEB-INF/"
				file="copernica/web.xml" />
		<copy todir="copernica/build/testwebapp-hsqldb">
			<fileset dir="copernica/jsp">
				<exclude name="*.jsp" />
				<exclude name="*.inc" />
			</fileset>
		</copy>
		
		<touch file="copernica/build/testwebapp-hsqldb/WEB-INF/web.xml" />
	
	</target>
	
	<target name="copernica.testwebapp.oracle"
			depends="copernica.compile, copernica.test.compile">
		
		<mkdir dir="copernica/build/testwebapp-oracle" />
		
		<copy todir="copernica/build/testwebapp-oracle/WEB-INF/classes">
			<fileset dir="lib/build/classes" />
			<fileset dir="lib/build/testclasses" />
			<fileset dir="copernica/build/classes" />
			<fileset dir="copernica/build/testclasses" />
		</copy>
		
		<copy todir="copernica/build/testwebapp-oracle/WEB-INF/lib">
			<fileset file="../lib/pcj.jar" />
			<!-- TODO: removed, when the test model gets it own model class independent of junit -->
			<fileset file="../lib/junit.jar" />
		</copy>
		<copy file="../lib/classes12.zip"
				tofile="copernica/build/testwebapp-oracle/WEB-INF/lib/classes12.jar" />
		
		<copy tofile="copernica/build/testwebapp-oracle/WEB-INF/cope.properties"
				file="cope.properties.oracle" />
		<copy todir="copernica/build/testwebapp-oracle/WEB-INF/"
				file="copernica/web.xml" />
		<copy todir="copernica/build/testwebapp-oracle">
			<fileset dir="copernica/jsp">
				<exclude name="*.jsp" />
				<exclude name="*.inc" />
			</fileset>
		</copy>
		
		<touch file="copernica/build/testwebapp-oracle/WEB-INF/web.xml" />
	
	</target>
	
	<target name="copernica.testwebapp"
			depends="copernica.testwebapp.hsqldb,
						copernica.testwebapp.oracle" />
	
	<target name="copernica.webtest.compile">
		<mkdir dir="copernica/build/webtestclasses" />
		<javac srcdir="copernica/webtestsrc"
				destdir="copernica/build/webtestclasses"
				deprecation="on"
				debug="on"
				optimize="off">
			<classpath>
				<fileset dir="../lib/jwebunit"> 
					<include name="*.jar" /> 
				</fileset> 
			</classpath>
		</javac>
	</target>
	
	<target name="copernica.webtest" depends="copernica.webtest.compile">
		<java classname="junit.textui.TestRunner" taskname="jwebunit"
				failonerror="yes" fork="yes">
			<classpath>
				<pathelement location="copernica/build/webtestclasses" />
				<fileset dir="../lib/jwebunit"> 
					<include name="*.jar" /> 
				</fileset> 
			</classpath>
			<arg value="com.exedio.copernica.PackageTest" />
		</java>
	</target>

	<target name="copernica" depends="copernica.compile" />
	
	<target name="lib.clean">
		<delete dir="lib/build" />
	</target>

	<target name="instrument.clean">
		<delete dir="instrument/build" />
	</target>

	<target name="copernica.clean">
		<delete dir="copernica/build" />
	</target>

	<target name="clean" depends="lib.clean, instrument.clean, copernica.clean" />
	
	
	<target name="lib.api" depends="properties">

		<delete dir="lib/api" />
		<mkdir  dir="lib/api" />

		<javadoc
				sourcepath="lib/src"
				destdir="lib/api"
				maxmemory="60m"
				private="${api.private}"
				author="on"
				use="on"
				version="on"
				windowtitle="Cope with Object Persistence"
				doctitle=   "Cope with Object Persistence&lt;br&gt;API Specification"
				header=     "COPE"
				footer=     "Cope with&lt;br&gt;Object&lt;br&gt;Persistence"
				splitindex="on"
				bottom='&lt;small&gt;&amp;copy; Copyright 2004 &lt;a href="http://www.exedio.com/" target="_top"&gt;exedio&lt;/a&gt; Gesellschaft f&amp;uuml;r Softwareentwicklung mbH. All rights reserved.&lt;small&gt;'
			>
			<package name="com.*" />
			<link href="${api.link.jdk}" />
			<classpath>
				<pathelement location="../lib/pcj.jar" />
			</classpath>
		</javadoc>
	</target>

	<target name="instrument.api" depends="properties">

		<delete dir="instrument/api" />
		<mkdir  dir="instrument/api" />

		<javadoc
				sourcepath="instrument/src"
				destdir="instrument/api"
				maxmemory="60m"
				private="${api.private}"
				author="on"
				use="on"
				version="on"
				windowtitle="Cope with Object Persistence"
				doctitle=   "Cope with Object Persistence&lt;br&gt;API Specification"
				header=     "COPE&lt;br&gt;Instrumentor"
				footer=     "Cope with&lt;br&gt;Object&lt;br&gt;Persistence"
				splitindex="on"
				bottom='&lt;small&gt;&amp;copy; Copyright 2004 &lt;a href="http://www.exedio.com/" target="_top"&gt;exedio&lt;/a&gt; Gesellschaft f&amp;uuml;r Softwareentwicklung mbH. All rights reserved.&lt;small&gt;'
			>
			<package name="com.*" />
			<link offline="on" packagelistLoc="lib/api" href="../../lib/api" />
			<link href="${api.link.jdk}" />
			<classpath>
				<pathelement location="lib/build/classes" />
			</classpath>
		</javadoc>
	</target>

	<target name="copernica.api" depends="properties">

		<delete dir="copernica/api" />
		<mkdir  dir="copernica/api" />

		<javadoc
				sourcepath="copernica/src"
				destdir="copernica/api"
				maxmemory="60m"
				private="${api.private}"
				author="on"
				use="on"
				version="on"
				windowtitle="Copernica"
				doctitle=   "Copernica&lt;br&gt;API Specification"
				header=     "Copernica"
				footer=     "Cope with&lt;br&gt;Object&lt;br&gt;Persistence"
				splitindex="on"
				bottom='&lt;small&gt;&amp;copy; Copyright 2004 &lt;a href="http://www.exedio.com/" target="_top"&gt;exedio&lt;/a&gt; Gesellschaft f&amp;uuml;r Softwareentwicklung mbH. All rights reserved.&lt;small&gt;'
			>
			<package name="com.*" />
			<link offline="on" packagelistLoc="lib/api" href="../../lib/api" />
			<link href="${api.link.jdk}" />
			<classpath>
				<pathelement location="lib/build/classes" />
			</classpath>
		</javadoc>
	</target>

	<target name="api" depends="lib.api, instrument.api, copernica.api" />
	
	<target name="all" depends="compile, test, jar, api, copernica.testwebapp" />

</project>
